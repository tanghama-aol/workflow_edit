# 嵌套工作流编辑器 - 设计文档

## 1. 系统概述

本系统是一个基于 JointJS 库实现的 Web 端图形化工作流编辑器。它采用原生 JavaScript 编写，旨在提供一个轻量级、可扩展的解决方案，用于创建和管理嵌套式工作流程图。系统核心是 JointJS，它提供了图形（Graph）、画布（Paper）、元素（Element）和连接（Link）等核心抽象。

## 2. 架构设计

系统架构分为三个主要部分：

1.  **视图层 (View)**: 由 `index.html` 文件构成，包含 HTML 结构、CSS 样式和所有 JavaScript 逻辑。
2.  **模型层 (Model)**: 由 JointJS 的 `dia.Graph` 对象管理，负责存储所有节点和连接的状态。
3.  **控制器层 (Controller)**: 由一系列事件监听器和处理函数组成，负责响应用户交互（如拖拽、点击）并更新模型和视图。

### 2.1. 技术选型

-   **核心库**: [JointJS](https://jointjs.com/) - 一个强大的 JavaScript 图表库，提供创建交互式图表和工作流所需的核心功能。
-   **依赖库**: jQuery, Lodash, Backbone.js (作为 JointJS 的依赖项)。
-   **语言**: 原生 JavaScript (ES6+), HTML5, CSS3。

## 3. 核心功能实现

### 3.1. JointJS 核心组件初始化

-   **`dia.Graph`**: `const graph = new dia.Graph({}, { cellNamespace: shapes });`
    -   用于存储图的所有元素（cells），包括节点和连接。
-   **`dia.Paper`**: `const paper = new dia.Paper({...});`
    -   负责将 `graph` 中的数据渲染为 SVG 矢量图形。
    -   关键配置：
        -   `embeddingMode: true`: 开启嵌套功能，允许元素包含其他元素。
        -   `validateEmbedding`: 定义一个函数，用于验证一个元素是否可以被嵌套到另一个元素中。在此实现中，它确保只有“容器”类型的节点可以作为父节点。
        -   `validateConnection`: 定义连接规则，例如，只允许在端口（magnet）之间建立连接。

### 3.2. 拖拽面板 (Stencil)

-   使用 `ui.Stencil` 组件实现。
-   它与 `paper` 关联，允许将预定义的形状拖拽到画布上。
-   通过 `stencil.load()` 方法加载不同类型的节点（如矩形、圆形和自定义容器）。

### 3.3. 自定义节点

-   **容器节点 (`app.Container`)**: 
    -   通过 `shapes.standard.Rectangle.define('app.Container', ...)` 创建一个自定义形状。
    -   它继承自标准矩形，并添加了一个 `isContainer: true` 的自定义属性，用于在 `validateEmbedding` 中进行识别。
-   **带端口的节点**: 
    -   为标准形状（如 `Rectangle`, `Ellipse`）添加 `ports` 属性。
    -   端口定义了可以创建连接的特定点，分为 `in` 和 `out` 两个组。

### 3.4. 嵌套逻辑

-   **拖入嵌套**: 通过监听 `paper` 的 `element:pointerup` 事件实现。当用户释放鼠标时，检查元素是否在一个容器的边界框内。如果是，则调用 `parent.embed(element)` 将其嵌入。
-   **子节点跟随**: 这是 JointJS 的内置功能。一旦一个元素被嵌入到另一个元素中，当父元素移动时，子元素会自动跟随。
-   **拖出嵌套**: 通过监听 `graph` 的 `change:position` 事件实现。当一个子节点移动时，检查其中心点是否仍在父容器的边界框内。如果不在，则调用 `parent.unembed(cell)` 解除嵌套关系。

### 3.5. 编辑功能

-   **编辑按钮**: 
    -   通过 `dia.ToolsView` 为元素动态添加工具按钮。
    -   监听 `paper` 的 `element:mouseenter` 和 `element:mouseleave` 事件来分别显示和隐藏工具。
    -   按钮被定义为一个 `ToolItem`，并包含一个自定义的 SVG 图标。
-   **编辑对话框**: 
    -   使用 HTML 的 `<dialog>` 元素创建一个模态对话框。
    -   当点击编辑按钮时，触发 `element:button:pointerdown` 事件。
    -   事件处理器从元素中获取当前数据（ID、标签、颜色），填充到对话框的表单中，然后调用 `dialog.showModal()` 显示对话框。
-   **保存更改**: 
    -   监听表单的 `submit` 事件。
    -   从表单中获取新值，并使用 `element.attr()` 方法更新 `graph` 中对应模型的属性。JointJS 会自动重新渲染更新后的元素。

## 4. 样式与美化 (CSS)

-   使用 Flexbox 进行现代化的页面布局，确保 Stencil 和 Paper 区域能自适应屏幕。
-   为 JointJS 元素（节点、连接、Stencil）提供自定义样式，以覆盖默认外观，提升视觉效果。
-   为编辑对话框提供简洁、清晰的样式，以改善用户体验。

## 5. 文件结构

```
/joint
├── index.html         # 主文件，包含所有 HTML, CSS, 和 JavaScript 代码
├── req.md             # 原始需求描述
├── 需求文档.md        # 生成的需求文档
└── 设计文档.md        # 生成的设计文档
```
